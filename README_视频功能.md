# 视频上传功能说明

## 新增功能

在原有的摄像头监控基础上，新增了本地视频文件上传和播放功能。

## 功能特点

### 1. 支持多种视频格式
- **常见格式**: MP4, AVI, MOV, MKV, WMV, FLV
- **网络格式**: WebM, M4V
- **移动设备格式**: 3GP
- **专业格式**: MPG, MPEG, TS, MTS, M2TS
- **其他格式**: 支持所有文件类型

### 2. 界面更新
- 在左侧控制面板新增了两个按钮：
  - **"上传本地视频文件"**: 用于选择视频文件
  - **"播放视频文件"**: 用于播放已选择的视频文件
- **新增状态指示器**: 显示当前是"待机"、"摄像头模式"还是"视频播放模式"

### 3. 智能状态管理
- 选择视频文件后，播放按钮自动启用
- 按钮文字会显示已选择的文件名（超过20字符会截断）
- **摄像头和视频播放模式完全分离**，切换时会自动停止另一个
- 实时状态显示，让用户清楚知道当前运行模式

### 4. 线程管理优化
- **摄像头线程按需启动**: 只有在点击"打开摄像头"时才启动摄像头线程
- **视频线程独立运行**: 视频处理在独立线程中进行
- **线程安全切换**: 确保在模式切换时线程能够正确启动和停止
- **资源管理**: 及时释放资源，避免内存泄漏

## 使用方法

### 步骤1: 上传视频文件
1. 点击"上传本地视频文件"按钮
2. 在弹出的文件对话框中选择要分析的视频文件
3. 选择完成后，按钮文字会更新显示文件名

### 步骤2: 播放视频
1. 点击"播放视频文件"按钮
2. 系统会自动关闭摄像头（如果正在运行）
3. 状态指示器会显示"视频播放模式"
4. 开始播放视频并进行行为检测

### 步骤3: 切换回摄像头
1. 点击"打开摄像头"按钮
2. 系统会自动停止视频播放
3. 等待3秒后启动摄像头
4. 状态指示器会显示"摄像头模式"

### 步骤4: 行为检测
- 视频播放时会实时进行姿态检测
- 支持检测的行为包括：
  - 站立 (stand)
  - 坐下 (sit)
  - 行走 (walk)
  - 举手 (L_hand up / R_hand up)

### 步骤5: 计时统计
- 可以同时进行计时和计数功能
- 统计信息会实时更新在界面上

## 技术实现

### 1. 多线程处理
- 视频处理在独立线程中进行，避免界面卡顿
- 使用线程安全的状态管理
- 线程按需启动和停止，提高资源利用效率

### 2. 帧率控制
- 根据视频原始帧率控制播放速度
- 保持视频播放的流畅性

### 3. 模型复用
- 使用相同的YOLO模型进行姿态检测
- 保持检测精度的一致性

### 4. 内存管理
- 及时释放视频资源
- 避免内存泄漏
- 线程安全的状态切换

### 5. 状态同步
- 使用事件对象控制线程启动和停止
- 确保模式切换时的数据一致性
- 实时状态反馈给用户

## 修复的问题

### 问题1: 摄像头和视频功能冲突
**问题描述**: 播放本地视频时摄像头也会同时打开
**解决方案**: 
- 修改主程序，摄像头线程不再自动启动
- 实现按需启动机制，只有点击"打开摄像头"时才启动
- 添加线程安全的状态切换机制

### 问题2: 状态不明确
**问题描述**: 用户无法知道当前是摄像头模式还是视频模式
**解决方案**:
- 添加状态指示器，实时显示当前运行模式
- 在模式切换时更新状态显示

### 问题3: 资源管理不当
**问题描述**: 线程可能无法正确停止，导致资源浪费
**解决方案**:
- 使用事件对象控制线程生命周期
- 添加超时机制确保线程能够正确停止
- 在finally块中确保资源正确释放

## 注意事项

1. **文件大小**: 建议视频文件不要过大，以免影响处理速度
2. **格式兼容**: 某些特殊编码的视频可能无法正常播放
3. **性能要求**: 视频处理需要一定的计算资源，建议在性能较好的设备上运行
4. **存储空间**: 确保有足够的存储空间用于临时文件
5. **线程安全**: 模式切换时请等待状态指示器更新完成

## 故障排除

### 问题1: 无法打开视频文件
- 检查文件路径是否正确
- 确认文件格式是否支持
- 检查文件是否损坏

### 问题2: 视频播放卡顿
- 降低视频分辨率
- 关闭其他占用资源的程序
- 检查设备性能

### 问题3: 检测效果不佳
- 确保视频中人物清晰可见
- 检查光线条件
- 调整检测置信度阈值

### 问题4: 模式切换失败
- 检查状态指示器显示
- 等待当前操作完成后再切换
- 重启程序如果问题持续

## 更新日志

- **v2.1**: 修复摄像头和视频功能分离问题
  - 实现线程按需启动机制
  - 添加状态指示器
  - 优化资源管理
  - 改进错误处理
- **v2.0**: 新增视频上传和播放功能
  - 支持多种视频格式
  - 优化用户界面
  - 改进错误处理 